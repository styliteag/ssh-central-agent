#!/usr/bin/env python3
#
# Copyright 2024, Wim Bonis, Stylite AG
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

###############################################################################
# SSH Agent Multiplexer Gateway Script (Python)
#
# This script manages SSH agent multiplexing, allowing users to combine
# local and remote SSH agents (e.g., YubiKey agent) into a single socket.
# It supports both Python (sshagentmux.py) and Rust (ssh-agent-mux) multiplexers.
#
# Usage: ./sca [options] [command]
###############################################################################

import os
import sys
from pathlib import Path

# Template variables (set by Ansible)
os.environ["RUSERNAME"] = "{{ remote_username }}"
os.environ["SCA_SSH_AUTH_SOCK"] = "{{ sca_auth_sock }}"
os.environ["MUX_SSH_AUTH_SOCK"] = "{{ mux_auth_sock }}"
os.environ["PLAYBOOK_DIR"] = "{{ playbook_dir }}"
os.environ["SSH_CONFIG_FILE"] = "{{ ssh_config_file }}"
os.environ["SCA_SCRIPT"] = __file__
{% if my_ssh_key is defined and my_ssh_key != '~/.ssh/id_unused' %}
os.environ["MY_SSH_KEY"] = "{{ my_ssh_key }}"
{% endif %}

# Add playbook directory to Python path
playbook_dir = Path("{{ playbook_dir }}").resolve()
sys.path.insert(0, str(playbook_dir))

# Import and run main function
try:
    from sca.__main__ import main
    main()
except ImportError as e:
    print(f"Error: Failed to import SCA module: {e}", file=sys.stderr)
    print("Make sure the sca package is installed or in the Python path", file=sys.stderr)
    sys.exit(1)
except Exception as e:
    print(f"Error: {e}", file=sys.stderr)
    import traceback
    traceback.print_exc()
    sys.exit(1)
